<% content_for :header_tags do %>
  <%= stylesheet_link_tag 'bootstrap.min', 'mykpi', 'all', 'semantic', 'bootstrap-table.min', 'bootstrap-editable', plugin: 'kpi_report' %>
  <%= javascript_include_tag 'popper.min', 'jquery-2.0.3.min', 'bootstrap.min.js', 'bootstrap-editable.min',
                             'bootstrap-table.min.js', 'bootstrap-table-editable.min', 'semantic.min.js', 'jquery.validate.min.js', 'bootstrap-table-filter-control.min.js', 'semantic.js', plugin: 'kpi_report' %>
<% end %>
<script>
    $('#header').css("display", "none");
    $('#top-menu').css("height", "50px")
    $('#top-menu').css("z-index", "10")
    $('#top-menu').css("z-index", "10")
    $('.checkbox').css("display", "none");
    $('#top-menu').css("position", "relative")
</script>
<style>
  a {
    color: inherit !important;
  }

  #content {
    z-index: unset;
  }
  #kpi_table td {
    overflow: hidden;
    text-overflow: ellipsis;
    /*//white-space: nowrap;*/
    font-size: 12px;
  }
  #kpi_table th {
    font-size: 12px;
  }
  /*#kpi_table{*/
  /*  zoom: 100%;*/
  /*}*/
    /*select{*/
    /*  width: 100%;*/
    /*}*/

</style>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Title</title>
</head>
<body>
<div>
  <div>
    <%= form_tag({:controller => 'my_kpi', :action => 'index'}, :method => :get, :id => "query_form", style: "display:flex;padding:10px") do %>
      <table style="margin: 0 auto;">
        <tr>
          <td>
            <h4 style="margin: 0">Phụ lục 04A: Tổng hợp kết quả đánh giá mức độ hoàn thành nhiệm vụ/công việc của CBNV tại đơn vị </h4>
          </td>
          <td><%= select_tag "kidanhgia", options_for_select(Project.find(1072).versions.map { |obj| [obj.name, obj.id] }, $kidanhgia), :onchange => 'this.form.submit()', :style => 'font-weight: bold;' %></td>
        </tr>
      </table>
    <% end %>
  </div>
  <div>
    <div style="display: table;margin: 0 auto;">(Kèm theo Quyết định số: 2345/QĐ-CNVTQĐ-TCNL ngày 10 tháng 07 năm 2020 của Tổng Giám đốc Tập đoàn)
    </div>
  </div>
  <input type="hidden" id="version_id1" value="<%=$kidanhgia %>">
  <div style="margin-bottom: 20px">
    <h4 style="margin: 0">Kỳ đánh giá: <%= select_tag "kidanhgia", options_for_select(Project.find(1072).versions.map { |obj| [obj.name, obj.id] }, $kidanhgia), :onchange => 'this.form.submit()', :style => 'font-weight: bold;' %></h4>
    <table id="kpi_table" class="table table-bordered striped table-responsive" style="width: 100%">
      <thead>
      <tr>
        <th rowspan="4">TT</th>
        <th rowspan="4">Mã nhân viên</th>
        <th rowspan="4">Họ và tên</th>
<!--        <th rowspan="4">Chức danh</th>-->
<!--        <th rowspan="4">Đơn vị</th>-->
<!--        <th rowspan="4">Phòng ban</th>-->
<!--        <th rowspan="4">Tổ nhóm</th>-->
        <th colspan="6" style="text-align:center">Kết quả hoàn thành nhiệm vụ/công việc quý 3/2020</th>
        <th rowspan="4">Ghi chú, đề xuất của người quản lý trực tiếp với CBNV</th>
        <th rowspan="4">Ghi chú, đề xuất của người Chỉ huy với CBNV</th>
        <th rowspan="4" style="width: 200px">Chú ý</th>
        <th rowspan="4" >Hành động</th>
      </tr>
      <tr>
        <th rowspan="2">Điểm đánh giá</th>
        <th rowspan="2">Xếp loại kết quả thực hiện mục tiêu nhiệm vụ/công việc</th>
        <th rowspan="2">Tuân thủ địa điểm làm việc</th>
        <th rowspan="2">Tuân thủ Nội quy lao động</th>
        <th rowspan="2">Xếp loại Ki</th>
        <th rowspan="2">Xếp loại mức độ hoàn thành nhiệm vụ/công việc</th>
      </tr>

      </thead>
      <tbody>
      <% $num = 0 %>
      <%# @kpi_raking.each do |kpi| %>
      <% (1..@kpi_raking.size).each do |i| %>
      <%# $num+=1 %>
      <tr  ki_id="<%= @ki_raking[$num][20] %>">
        <td><%= $num+1  %></td>
        <td><%= @kpi_raking[$num].employee_id %></td>
        <td><%= CustomValue.where(customized_id: @kpi_raking[$num].user_id, custom_field_id: 56).select(:value).take(1).nil? ? "N/A" : CustomValue.where(customized_id: @kpi_raking[$num].user_id, custom_field_id: 56).select(:value).take(1).first.value %></td>
<!--        <td><%#= @kpi_raking[$num].job_title %></td>-->
<!--        <td><%#= CustomValue.where(customized_id: @kpi_raking[$num].user_id, custom_field_id: 53).select(:value).take(1).nil? ? "N/A" : CustomValue.where(customized_id: @kpi_raking[$num].user_id, custom_field_id: 53).select(:value).take(1).first.value %></td>-->
<!--        <td><%#= CustomValue.where(customized_id: @kpi_raking[$num].user_id, custom_field_id: 54).select(:value).take(1).nil? ? "N/A" : CustomValue.where(customized_id: @kpi_raking[$num].user_id, custom_field_id: 54).select(:value).take(1).first.value %></td>-->
<!--        <td></td>-->
        <td><%=@ki_raking[$num][23] %></td>
        <td>
          <% if @ki_raking[$num][23].nil? %>
            Không đánh giá
          <% elsif @ki_raking[$num][23] < 2 %>
            Không đạt yêu cầu
          <% elsif 2<= @ki_raking[$num][23] < 2.5 %>
            Gần đạt yêu cầu
          <% elsif 2.5<= @ki_raking[$num][23] < 3.5 %>
            Đạt yêu cầu
          <% elsif 3.5<= @ki_raking[$num][23] < 4.5 %>
            Vượt yêu cầu
          <% elsif 4.5<= @ki_raking[$num][23] <= 5 %>
            Vượt xa yêu cầu
          <% end %>
        </td>
        <td>
          <select >
            <% if @ki_raking[$num][25] == 1 || @ki_raking[$num][25].nil?%>
              <option value="1" selected="selected">Tuân thủ</option>
              <option value="2">Không tuân thủ</option>
            <% elsif @ki_raking[$num][25] == 2 %>
              <option value="1">Tuân thủ</option>
              <option value="2" selected="selected">Không tuân thủ</option>
            <% end %>
          </select>
        </td>
        <td>
          <select>
            <% if @ki_raking[$num][26].nil? || @ki_raking[$num][26] == 1%>
              <option value="1" selected="selected">Tuân thủ</option>
              <option value="2">Vi phạm nhưng chưa đến mức bị xử lý kỷ luật</option>
              <option value="3">Bị xử lý kỷ luật lao động</option>
            <% elsif @ki_raking[$num][26] == 2 %>
              <option value="1">Tuân thủ</option>
              <option value="2" selected="selected">Vi phạm nhưng chưa đến mức bị xử lý kỷ luật</option>
              <option value="3">Bị xử lý kỷ luật lao động</option>
            <% elsif @ki_raking[$num][26] == 3 %>
              <option value="1">Tuân thủ</option>
              <option value="2">Vi phạm nhưng chưa đến mức bị xử lý kỷ luật</option>
              <option value="3" selected="selected">Bị xử lý kỷ luật lao động</option>
            <% end %>
          </select>
        </td>
        <td>
          <select id="<%= "select_ki"+$num.to_s %>" onchange="mySelectKI(<%= $num %>)">
            <% if @ki_raking[$num][27].nil? or @ki_raking[$num][27]=="" %>
              <option value="" selected="selected"></option>
              <option value="A+">A+</option>
              <option value="A">A</option>
              <option value="B">B</option>
              <option value="C">C</option>
              <option value="D">D</option>
              <option value="K">K</option>
            <% elsif @ki_raking[$num][27] == "A+" %>
              <option value="" selected="selected"></option>
              <option value="A+" selected="selected">A+</option>
              <option value="A">A</option>
              <option value="B">B</option>
              <option value="C">C</option>
              <option value="D">D</option>
              <option value="K">K</option>
            <% elsif @ki_raking[$num][27] == "A" %>
              <option value="" selected="selected"></option>
              <option value="A+">A+</option>
              <option value="A" selected="selected">A</option>
              <option value="B">B</option>
              <option value="C">C</option>
              <option value="D">D</option>
              <option value="K">K</option>
            <% elsif @ki_raking[$num][27] == "B" %>
              <option value="" selected="selected"></option>
              <option value="A+">A+</option>
              <option value="A">A</option>
              <option value="B" selected="selected">B</option>
              <option value="C">C</option>
              <option value="D">D</option>
              <option value="K">K</option>
            <% elsif @ki_raking[$num][27] == "C" %>
              <option value="" selected="selected"></option>
              <option value="A+">A+</option>
              <option value="A">A</option>
              <option value="B">B</option>
              <option value="C" selected="selected">C</option>
              <option value="D">D</option>
              <option value="K">K</option>
            <% elsif @ki_raking[$num][27] == "D" %>
              <option value="" selected="selected"></option>
              <option value="A+">A+</option>
              <option value="A">A</option>
              <option value="B">B</option>
              <option value="C">C</option>
              <option value="D" selected="selected">D</option>
              <option value="K">K</option>
            <% elsif @ki_raking[$num][27] == "K" %>
              <option value="" selected="selected"></option>
              <option value="A+">A+</option>
              <option value="A">A</option>
              <option value="B">B</option>
              <option value="C">C</option>
              <option value="D">D</option>
              <option value="K" selected="selected">K</option>
            <% end %>
          </select>
        </td>
        <td id="<%= "text_ki"+$num.to_s %>">
          <% if @ki_raking[$num][27].nil? or @ki_raking[$num][27]=="" %>
            Không đánh giá
          <% elsif @ki_raking[$num][27] == "A+" %>
            Vượt xa yêu cầu
          <% elsif @ki_raking[$num][27] == "A" %>
            Vượt yêu cầu
          <% elsif @ki_raking[$num][27] == "B" %>
            Đạt yêu cầu
          <% elsif @ki_raking[$num][27] == "C" %>
            Gần đạt yêu cầu
          <% elsif @ki_raking[$num][27] == "D" %>
            Không đạt yêu cầu
          <% elsif @ki_raking[$num][27] == "K" %>
            Không đánh giá
          <% end %>
        </td>
        <td>
          <% $comment = "" %>
          haidn4: tốt
          hamg: tốt
        </td>
        <td><textarea id="<%= "m_note"+$num.to_s %>" style="width:100%;"><%= @ki_raking[$num][30]  %></textarea> </td>
        <td><textarea id="<%= "note"+$num.to_s %>" style="width:100%;"><%= @ki_raking[$num][31]  %></textarea></td>
        <td>
          <a title="Lưu" href="#" onclick="saveChangeKI(this,<%=$num.to_s%>)" class="btn btn-success">
            <i class="fa fa-check"></i>
          </a>
        </td>
        <tr>
          <% $num+=1 %>
      <% end %>
      </tbody>
      <tfoot>

      </tfoot>
    </table>
  </div>
</div>
</body>
</html>

<script type="text/javascript" charset="utf-8">
    function mySelectKI(num){
        var ki = $('#select_ki'+num).val();
        if (ki == "" || ki == "K"){
            $('#text_ki'+num).text("Không đánh giá");
        }
        else if(ki == "A+"){
            $('#text_ki'+num).text("Vượt xa yêu cầu");
        }
        else if(ki == "A"){
            $('#text_ki'+num).text("Vượt yêu cầu");
        }
        else if(ki == "B"){
            $('#text_ki'+num).text("Đạt yêu cầu");
        }
        else if(ki == "C"){
            $('#text_ki'+num).text("Gần đạt yêu cầu");
        }
        else if(ki == "D"){
            $('#text_ki'+num).text("Không đạt yêu cầu");
        }
    }
    function saveChangeKI(btn,num){
        let data = $(btn).parent().parent()
        let ki_id = $(btn).parent().parent().attr("ki_id");
        let version_id = $('#version_id1').val();
        let empObj = {
            ki_id: ki_id,
            user_code: data.find("td:eq(1)").text(),
            version_id: version_id,
            location: data.find("select:eq(0)").val(),
            labor_rules: data.find("select:eq(1)").val(),
            ki: data.find("select:eq(2)").val(),
            manage_note: $('#m_note'+num).val(),
            note: $('#note'+num).val()
        };
        let url = 'http://' + $(location).attr('host') + '/kpi_ranking/test';
        $.ajax({
            type:"GET",
            url:url,
            dataType:"json",
            data: empObj,
            success:function(result) {
                location.reload();
            },
            error: function(){
            }
        })
    }
</script>