<% content_for :header_tags do %>
  <%= stylesheet_link_tag 'bootstrap.min', 'mykpi', 'all', 'semantic', 'bootstrap-table.min', 'bootstrap-editable', plugin: 'kpi_report' %>
  <%= javascript_include_tag 'popper.min', 'jquery-2.0.3.min', 'bootstrap.min.js', 'bootstrap-editable.min',
                             'bootstrap-table.min.js', 'bootstrap-table-editable.min', 'semantic.min.js', 'jquery.validate.min.js', 'bootstrap-table-filter-control.min.js', 'semantic.js', plugin: 'kpi_report' %>
<% end %>
<script>
    $('#header').css("display", "none");
</script>
<style>
    a {
        color: inherit !important;
    }
</style>
<div style="width: 100%;display: flex">
  <div class="kpi-content ">
    <div>
      <%= form_tag({:controller => 'my_kpi', :action => 'index'}, :method => :get, :id => "query_form", style: "display:flex;padding:10px") do %>
        <table>
          <tr>
            <td>Kì KI</td>
            <td><%= select_tag "kidanhgia", options_for_select(Project.find(1072).versions.map { |obj| [obj.name, obj.id] }, $kidanhgia) %></td>
          </tr>
        </table>
        <%= submit_tag "Search", :name => nil %>
        </p>
      <% end %>
    </div>
    <table id="table"
           data-filter-control="true"
           data-sortable="true"
           data-show-export="true">
      <thead>
      <tr>
        <th data-field="status" data-sortable="true">Status</th>
        <th data-field="muctieu">Mục tiêu</th>
        <th data-field="type" data-sortable="true">Loại kpi
        </th>
        <th data-field="chiso">Chỉ số KPI</th>
        <th data-field="assignee" data-sortable="true">CBNV</th>
        <th data-field="donvido">Đơn vị
          đo
        </th>
        <th data-field="tytrong" data-sortable="true">Tỷ
          trọng
        </th>
        <th data-field="s">S</th>
        <th data-field="b">B</th>
        <th data-field="t">T</th>
        <th data-field="kq">KQ</th>
        <th data-field="tu_danh_gia">Tự
          đánh giá
        </th>
        <th data-field="qltt_danh_gia">QLTT
          đánh giá
        </th>
        <th data-field="action">Action</th>
      </tr>
      </thead>
      <tbody>
      <% @kpi_open_dinh_luong.each do |kpi| %>
        <tr id=<%= kpi.id %> status="saved">
          <td>
            <a href="#"> <%= kpi.status.name %></a>
          </td>
          <td>
            <a href="#" id=<%= kpi.id.to_s + "_muctieu" %>> <%= issue_customfield_value(kpi, 1) %></a>
          </td>
          <td>
            <a href="#" id=<%= kpi.id.to_s + "_tracker" %>><%= kpi.tracker.name %></a>
          </td>
          <td>
            <a href="#" id=<%= kpi.id.to_s + "_subject" %>> <%= kpi.subject %></a>
          </td>
          <td>
            <a href="#" id=<%= kpi.id.to_s + "_author" %>><%= kpi.assigned_to %></a>
          </td>
          <td>
            <a href="#" id=<%= kpi.id.to_s + "_donvido" %>><%= issue_customfield_value(kpi, 138) %></a>
          </td>
          <td>
            <a href="#" id=<%= kpi.id.to_s + "_titrong" %>> <%= issue_customfield_value(kpi, 139) %></a>
          </td>
          <% if kpi.tracker_id == 39 %>
            <td>
              <a href="#" id=<%= kpi.id.to_s + "_s" %>><%= issue_customfield_value(kpi, 142) %></a>
            </td>
            <td>
              <a href="#" id=<%= kpi.id.to_s + "_b" %>> <%= issue_customfield_value(kpi, 143) %></a>
            </td>
            <td>
              <a href="#" id=<%= kpi.id.to_s + "_t" %>> <%= issue_customfield_value(kpi, 144) %></a>
            </td>
            <td>
              <a href="#" id=<%= kpi.id.to_s + "_kq" %>> <%= issue_customfield_value(kpi, 145) %></a>
            </td>
          <% end %>
          <% if kpi.tracker_id == 40 %>
            <td>
              <a href="#" id=<%= kpi.id.to_s + "_s" %>><%= issue_customfield_value(kpi, 146) %></a>
            </td>
            <td>
              <a href="#" id=<%= kpi.id.to_s + "_b" %>> <%= issue_customfield_value(kpi, 147) %></a>
            </td>
            <td>
              <a href="#" id=<%= kpi.id.to_s + "_t" %>> <%= issue_customfield_value(kpi, 148) %></a>
            </td>
            <td>
              <a href="#" id=<%= kpi.id.to_s + "_kq" %>> <%= issue_customfield_value(kpi, 149) %></a>
            </td>
          <% end %>
          <% if kpi.tracker_id == 41 %>
            <td>
              <a href="#" id=<%= kpi.id.to_s + "_s" %>><%= issue_customfield_value(kpi, 158) %></a>
            </td>
            <td>
              <a href="#" id=<%= kpi.id.to_s + "_b" %>> <%= issue_customfield_value(kpi, 159) %></a>
            </td>
            <td>
              <a href="#" id=<%= kpi.id.to_s + "_t" %>> <%= issue_customfield_value(kpi, 160) %></a>
            </td>
            <td>
              <a href="#" id=<%= kpi.id.to_s + "_kq" %>> <%= issue_customfield_value(kpi, 151) %></a>
            </td>
          <% end %>
          <td>
            <a href="#" id=<%= kpi.id.to_s + "_cbnv_point" %>> <%= issue_customfield_value(kpi, 140) %></a>
          </td>
          <td>
            <a href="#" id=<%= kpi.id.to_s + "_qltt_point" %>> <%= issue_customfield_value(kpi, 141) %></a>
          </td>
          <% if kpi.status.id == 29 %>
            <td>
              <button style="margin-bottom: 10px;width: 100%" type="button" onclick="thongnhat(<%=kpi.id %>)" class="btn btn-light">Thống
                nhất
              </button>
              <button style="width: 100%" type="button" class="btn btn-danger" data-toggle="modal" data-target="#huyModal"
                      data-whatever="<%= kpi.id %>">Hủy KPI
              </button>
            </td>
          <% elsif kpi.status.id == 32 %>
            <td>
              <button style="width: 100%" type="button" class="btn btn-danger" data-toggle="modal" data-target="#huyModal"
                      data-whatever="<%= kpi.id %>">Hủy KPI
              </button>
            </td>
          <% elsif kpi.status.id == 35 %>
            <td>
              <button style="width: 100%" type="button" onclick="duthao(<%=kpi.id %>)" class="btn btn-info">Dự thảo</button>
            </td>
          <% elsif kpi.status.id == 33 %>
            <td>
              <button style="width: 100%" type="button" class="btn btn-info" data-toggle="modal" data-target="#qlttdanhgiaModal"
                      <%= kpi.id %>>Đánh giá
              </button>
            </td>
          <% else %>
            <td></td>

          <% end %>
        </tr>
      <% end %>
      </tbody>
    </table>
    <script>
        $(function () {
            $('#table').bootstrapTable()
        })

    </script>
  </div>
  <!--  model huy kpi-->
  <div style="background: none;z-index: 1050" class="modal fade" id="huyModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">Hủy KPI</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <form id="modal-form">
            <div class="form-group">
              <label for="message-text" class="col-form-label">Lý do hủy:</label>
              <textarea required class="form-control" id="message-text"></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button id="close-huy" type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          <button id="modal-huy" type="button" class="btn btn-danger">Huỷ KPI</button>
        </div>
      </div>
    </div>
  </div>
  <!--  end-->
  <!--  model tu danh gia-->
  <div style="background: none;z-index: 1050" class="modal fade" id="tudanhgiaModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">Tự đánh giá</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <form id="tudanhgia-form">
            <div class="form-group">
              <label for="message-text" class="col-form-label">Kết quả</label>
              <input type="text" class="form-control" id="ketqua" required>
            </div>
            <div class="form-group">
              <label for="message-text" class="col-form-label">Điểm</label>
              <select style="border:#2f3032 solid 1px" id="tudanhgia-diem" class="custom-select" required>
                <option value="">-- Chọn điểm --</option>
                <option value="75">1: KQ < T</option>
                <option value="76">2: T ≤ KQ < B</option>
                <option value="77">3: KQ = B</option>
                <option value="78">4: B < KQ < S</option>
                <option value="79">5: KQ ≥ S</option>
              </select>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button id="close-tudanhgia" type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          <button id="btn-tudanhgia" type="button" class="btn btn-danger">Tự đánh giá</button>
        </div>
      </div>
    </div>
  </div>
  <!--  end-->
  <!--  model qltt danh gia-->
  <div style="background: none;z-index: 1050" class="modal fade" id="qlttdanhgiaModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">Đánh giá KPI CBNV</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <form id="qltt-danhgia-form">
            <div class="form-group">
              <label for="message-text" class="col-form-label">Điểm cho KPI</label>
              <select style="border:#2f3032 solid 1px" id="qltt-danhgia-diem" class="custom-select" required>
                <option value="">-- Chọn điểm --</option>
                <option value="75">1: KQ < T</option>
                <option value="76">2: T ≤ KQ < B</option>
                <option value="77">3: KQ = B</option>
                <option value="78">4: B < KQ < S</option>
                <option value="79">5: KQ ≥ S</option>
              </select>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button id="close-qltt-danhgia" type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          <button id="btn-qltt-danhgia" type="button" class="btn btn-danger">Đánh giá</button>
        </div>
      </div>
    </div>
  </div>
  <!--  end-->
  <div class="formedit">
    <div class="form-content">
      <div class="ui medium header">KPI Details</div>
      <form class="ui form">
        <input type="hidden" name="issue-id" id="issue-id">
        <div class="six wide field">
          <label>Tracker</label>
          <div id="tracker" class="ui disabled selection dropdown">
            <input type="hidden" name="tracker">
            <i class="dropdown icon"></i>
            <div class="default text">Tracker</div>
            <div class="menu">
              <div class="header">Tracker</div>
              <div class="item" data-value="39">KPIs - Định lượng</div>
              <div class="item" data-value="40">KPIs - Thời hạn</div>
              <div class="item" data-value="41">KPIs - Định mức</div>
            </div>
          </div>
        </div>
        <div class="two fields">
          <div class="nine wide field">
            <label>Subject</label>
            <textarea id='subject' disabled rows="2"></textarea>
          </div>
          <div class="five wide field">
            <label>Tỉ trọng(%)</label>
            <input id='titrong' max="100" disabled type="number" placeholder="Tỉ trọng(%)">
          </div>
        </div>
        <div class="field">
          <label>Description</label>
          <textarea id='description' disabled style="width: 87%" rows="3"></textarea>
        </div>
        <!--        status assignee-->
        <div class="two fields">
          <div class="six wide field">
            <label>Status</label>
            <div style="margin-bottom: 10px" id="status" class="ui disabled selection dropdown">
              <input type="hidden" name="tracker">
              <i class="dropdown icon"></i>
              <div class="default text">Status</div>
            </div>
          </div>
          <div class="six wide field">
            <label>Assignee</label>
            <div style="margin-bottom: 10px" id="assign" class="ui disabled search selection dropdown">
              <input type="hidden" name="tracker">
              <i class="dropdown icon"></i>
              <div class="default text">Assignee</div>
            </div>
          </div>
        </div>
        <div class="two fields">
          <div class="six wide field">
            <label>Category</label>
            <div style="margin-bottom: 10px" id="category" class="ui disabled selection dropdown">
              <input type="hidden" name="tracker">
              <i class="dropdown icon"></i>
              <div class="default text">Category</div>
            </div>
          </div>
          <div class="six wide field">
            <label>Target Version</label>
            <div style="margin-bottom: 10px" id="target_version" class="ui disabled selection dropdown">
              <input type="hidden" name="tracker">
              <i class="dropdown icon"></i>
              <div class="default text">Target Version</div>
            </div>
          </div>
        </div>

        <div class="two fields">
          <div style="width: 42%;" class="field">
            <label>Start date</label>
            <div class="ui calendar" id="rangestart">
              <div style="margin: 0;padding: 0" class="ui input left icon">
                <i class="calendar icon"></i>
                <input id='start_date' type="text" placeholder="Start">
              </div>
            </div>
          </div>
          <div style="width: 42%;" class="field">
            <label>End date</label>
            <div class="ui calendar" id="rangeend">
              <div style="margin: 0;padding: 0" class="ui input left icon">
                <i class="calendar icon"></i>
                <input id='due_date' type="text" placeholder="End">
              </div>
            </div>
          </div>
        </div>
        <div class="two fields">
          <div class="seven wide field">
            <label>Mục tiêu/ Kết quả mong đợi</label>
            <textarea id='muctieu' disabled rows="2"></textarea>
          </div>
          <div class="seven wide field">
            <label>Lý do Dừng/ Hủy</label>
            <textarea id='lydodung' disabled rows="2"></textarea>
          </div>
        </div>
        <div id="div-don-vi-do" class="two fields">
          <div class="seven wide field">
            <label>Đơn vị đo</label>
            <div style="margin-bottom: 10px" id="donvido" class="ui disabled selection dropdown">
              <input type="hidden" name="tracker">
              <i class="dropdown icon"></i>
              <div class="default text">Đơn vị đo</div>
            </div>
          </div>
        </div>

        <div id="none-thoihan" class="four fields">
          <div style="margin-right: 10px" class="three wide required field">
            <label>Tối thiểu</label>
            <input type="number" step="0.01" id="toithieu" disabled type="text">
          </div>
          <div style="margin-right: 10px" class="three wide required field">
            <label>Mong đợi</label>
            <input type="number" step="0.01" id="mongdoi" disabled type="text">
          </div>
          <div style="margin-right: 10px" class="three wide required field">
            <label>Thách thức</label>
            <input type="number" step="0.01" id="thachthuc" disabled type="text">
          </div>
          <div style="margin-right: 10px" class="three wide field">
            <label>Kết quả</label>
            <input type="number" step="0.01" id="ketqua" disabled type="text">
          </div>

        </div>
        <div style="display: none" id="thoihan">
          <div class="two fields">
            <div style="width: 42%;" class="field">
              <label>Tối thiểu</label>
              <div class="ui calendar" id="date-toithieu">
                <div style="margin: 0;padding: 0" class="ui input left icon">
                  <i class="calendar icon"></i>
                  <input id='date-toithieu-value' type="text" placeholder="Tối thiểu">
                </div>
              </div>
            </div>
            <div style="width: 42%;" class="field">
              <label>Mong đợi</label>
              <div class="ui calendar" id="date-mongdoi">
                <div style="margin: 0;padding: 0" class="ui input left icon">
                  <i class="calendar icon"></i>
                  <input id='date-mongdoi-value' type="text" placeholder="Mong đợi">
                </div>
              </div>
            </div>
          </div>
          <div class="two fields">
            <div style="width: 42%;" class="field">
              <label>Thách thức</label>
              <div class="ui calendar" id="date-thachthuc">
                <div style="margin: 0;padding: 0" class="ui input left icon">
                  <i class="calendar icon"></i>
                  <input id='date-thachthuc-value' type="text" placeholder="Thách thức">
                </div>
              </div>
            </div>
            <div style="width: 42%;" class="field">
              <label>Kết quả</label>
              <div class="ui calendar" id="date-ketqua">
                <div style="margin: 0;padding: 0" class="ui input left icon">
                  <i class="calendar icon"></i>
                  <input id='date-ketqua-value' type="text" placeholder="Kết quả">
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="two fields">
          <div class="six wide field">
            <label>Điểm CBNV tự đánh giá</label>
            <div style="margin-bottom: 10px" id="cbnv_point" class="ui disabled selection dropdown">
              <input type="hidden" name="tracker">
              <i class="dropdown icon"></i>
              <div class="default text">Điểm CBNV tự đánh giá</div>
              <div class="menu">
                <div class="item" data-value="39">KPIs - Định lượng</div>
                <div class="item" data-value="40">KPIs - Thời hạn</div>
                <div class="item" data-value="41">KPIs - Định mức</div>
              </div>
            </div>
          </div>
          <div class="six wide field">
            <label>Điểm QLTT đánh giá</label>
            <div style="margin-bottom: 10px" id="qltt_point" class="ui disabled selection dropdown">
              <input type="hidden" name="tracker">
              <i class="dropdown icon"></i>
              <div class="default text">Điểm QLTT đánh giá</div>
              <div class="menu">
                <div class="item" data-value="39">KPIs - Định lượng</div>
                <div class="item" data-value="40">KPIs - Thời hạn</div>
                <div class="item" data-value="41">KPIs - Định mức</div>
              </div>
            </div>
          </div>
        </div>

        <button onclick="actionSave()" class="ui button" type="button">Submit</button>
      </form>
    </div>
  </div>
</div>

<script>
    $('#tracker').dropdown({
        onChange: function (value, text, $selectedItem) {
            if (value == 39) {
                $('#thoihan').hide();
                $('#none-thoihan').show();
                $('#div-don-vi-do').show();
            } else if (value == 41) {
                $('#thoihan').hide();
                $('#none-thoihan').show();
                $('#div-don-vi-do').hide();
            } else {
                $('#thoihan').show();
                $('#none-thoihan').hide();
                $('#div-don-vi-do').hide();
            }
        }
    });
    $('#rangestart').calendar({
        type: 'date',
        endCalendar: $('#rangeend')
    });
    $('#rangeend').calendar({
        type: 'date',
        startCalendar: $('#rangestart')
    });
    $('#date-toithieu').calendar({
        type: 'date',
    });
    $('#date-mongdoi').calendar({
        type: 'date',
    });
    $('#date-thachthuc').calendar({
        type: 'date',
    });
    $('#date-ketqua').calendar({
        type: 'date',
    });
</script>
<script>
    function fillData(issue) {
        let id = $(issue).attr("id");
        $('#issue-id').val(id);
        getStatus(id);
    }

    function getStatus(id) {
        $.ajax({
            url: '/my_kpi/status/' + id + '/<%=User.current.id%>.json',
            type: 'GET',
            success: function (response) {
                console.log(response);
                $('#status').dropdown({
                    values: response.status,
                    placeholder: 'Status',
                    onChange: function (value, text, $selectedItem) {
                        changeStatus(value)
                    }
                })
                let status_select = response.status.filter(status => status.selected);
                changeStatus(status_select[0].value)
                $('#assign').dropdown({
                    values: response.assignee,
                    placeholder: 'Assignee'
                })
                $('#target_version').dropdown({
                    values: response.version,
                    placeholder: 'Target Version'
                })
                $('#category').dropdown({
                    values: response.category,
                    placeholder: 'Category'
                })
                $('#donvido').dropdown({
                    values: response.don_vi_do,
                    placeholder: 'Đơn vị đo'
                })
                $('#vp-kpi').dropdown({
                    values: response.vp_kpi,
                    placeholder: '[VP] KPIs định lượng chính'
                })
                $('#cbnv_point').dropdown({
                    values: response.cbnv_point,
                    placeholder: 'Điểm CBNV tự đánh giá'
                })
                $('#qltt_point').dropdown({
                    values: response.qltt_point,
                    placeholder: 'Điểm QLTT đánh giá'
                })
                $('#tracker').dropdown('set selected', response.tracker);
                if (response.tracker == 39) {
                    $('#thoihan').hide();
                    $('#none-thoihan').show();
                    $('#toithieu').get(0).type = 'number';
                    $('#mongdoi').get(0).type = 'number';
                    $('#thachthuc').get(0).type = 'number';
                    $('#ketqua').get(0).type = 'number';
                    $('#div-don-vi-do').show();
                    $('#toithieu').val(response.toithieu)
                    $('#mongdoi').val(response.mongdoi)
                    $('#thachthuc').val(response.thachthuc)
                    $('#ketqua').val(response.ketqua)
                } else if (response.tracker == 41) {
                    $('#thoihan').hide();
                    $('#none-thoihan').show();
                    $('#toithieu').get(0).type = 'text';
                    $('#mongdoi').get(0).type = 'text';
                    $('#thachthuc').get(0).type = 'text';
                    $('#ketqua').get(0).type = 'text';
                    $('#div-don-vi-do').hide();
                    $('#toithieu').val(response.toithieu)
                    $('#mongdoi').val(response.mongdoi)
                    $('#thachthuc').val(response.thachthuc)
                    $('#ketqua').val(response.ketqua)
                } else if (response.tracker == 40) {
                    $('#thoihan').show();
                    $('#none-thoihan').hide();
                    $('#div-don-vi-do').hide();
                    $('#date-toithieu-value').val(response.toithieu)
                    $('#date-mongdoi-value').val(response.mongdoi)
                    $('#date-thachthuc-value').val(response.thachthuc)
                    $('#date-ketqua-value').val(response.ketqua)
                }
                $('#subject').val(response.subject)
                $('#' + id).find("td:eq(0)").html(response.subject)
                $('#' + id).find("td:eq(2)").html(response.ti_trong)
                $('#' + id).find("td:eq(3)").html($('#donvido').dropdown('get text'))
                $('#' + id).find("td:eq(4)").html(response.toithieu)
                $('#' + id).find("td:eq(5)").html(response.mongdoi)
                $('#' + id).find("td:eq(6)").html(response.thachthuc)
                $('#' + id).find("td:eq(7)").html($('#cbnv_point').dropdown('get text') === "Điểm CBNV tự đánh giá" ? "" : $('#cbnv_point').dropdown('get text'))
                $('#' + id).find("td:eq(8)").html($('#qltt_point').dropdown('get text') === "Điểm QLTT đánh giá" ? "" : $('#qltt_point').dropdown('get text'))
                $('#assign').dropdown('get value')
                $('#titrong').val(response.ti_trong)
                $('#description').val(response.description)
                $('#start_date').val(response.start_date)
                $('#due_date').val(response.due_date)
                $('#muctieu').val(response.muc_tieu)
                $('#lydodung').val(response.ly_do_huy)
            },
            error: function (error) {
                alert('Error: ' + error)
            }
        });
    }

    function actionSave() {
        $('.segment').dimmer('show');
        let url = 'http://' + $(location).attr('host') + '/issues/' + $('#issue-id').val() + '.json?key=<%=User.current.api_key%>';
        console.log(url)
        if ($('#tracker').dropdown('get value') === "39") {
            data = {
                "issue": {
                    "tracker_id": $('#tracker').dropdown('get value'),
                    "subject": $('#subject').val(),
                    "description": $('#description').val(),
                    "assigned_to_id": $('#assign').dropdown('get value'),
                    "status_id": $('#status').dropdown('get value'),
                    "category_id": $('#category').dropdown('get value'),
                    "fixed_version_id": $('#target_version').dropdown('get value'),
                    "start_date": getFormattedDate(new Date($('#start_date').val())),
                    "due_date": getFormattedDate(new Date($('#due_date').val())),
                    "custom_field_values": {
                        "1": $('#muctieu').val(),
                        "47": $('#lydodung').val(),
                        "138": $('#donvido').dropdown('get value'),
                        "140": $('#cbnv_point').dropdown('get value'),
                        "141": $('#qltt_point').dropdown('get value'),
                        "142": $('#toithieu').val(),
                        "143": $('#mongdoi').val(),
                        "144": $('#thachthuc').val(),
                        "145": $('#ketqua').val(),
                    }
                }
            }
        } else if ($('#tracker').dropdown('get value') === "40") {
            data = {
                "issue": {
                    "tracker_id": $('#tracker').dropdown('get value'),
                    "subject": $('#subject').val(),
                    "description": $('#description').val(),
                    "assigned_to_id": $('#assign').dropdown('get value'),
                    "status_id": $('#status').dropdown('get value'),
                    "category_id": $('#category').dropdown('get value'),
                    "fixed_version_id": $('#target_version').dropdown('get value'),
                    "start_date": getFormattedDate(new Date($('#start_date').val())),
                    "due_date": getFormattedDate(new Date($('#due_date').val())),
                    "custom_field_values": {
                        "1": $('#muctieu').val(),
                        "47": $('#lydodung').val(),
                        "138": $('#donvido').dropdown('get value'),
                        "140": $('#cbnv_point').dropdown('get value'),
                        "141": $('#qltt_point').dropdown('get value'),
                        "146": getFormattedDate(new Date($('#date-toithieu-value').val())),
                        "147": getFormattedDate(new Date($('#date-mongdoi-value').val())),
                        "148": getFormattedDate(new Date($('#date-thachthuc-value').val())),
                        "149": getFormattedDate(new Date($('#date-ketqua-value').val())),
                    }
                }
            }
        } else if ($('#tracker').dropdown('get value') === "41") {
            data = {
                "issue": {
                    "tracker_id": $('#tracker').dropdown('get value'),
                    "subject": $('#subject').val(),
                    "description": $('#description').val(),
                    "assigned_to_id": $('#assign').dropdown('get value'),
                    "status_id": $('#status').dropdown('get value'),
                    "category_id": $('#category').dropdown('get value'),
                    "fixed_version_id": $('#target_version').dropdown('get value'),
                    "start_date": getFormattedDate(new Date($('#start_date').val())),
                    "due_date": getFormattedDate(new Date($('#due_date').val())),
                    "custom_field_values": {
                        "1": $('#muctieu').val(),
                        "47": $('#lydodung').val(),
                        "138": $('#donvido').dropdown('get value'),
                        "140": $('#cbnv_point').dropdown('get value'),
                        "141": $('#qltt_point').dropdown('get value'),
                        "158": $('#toithieu').val(),
                        "159": $('#mongdoi').val(),
                        "160": $('#thachthuc').val(),
                        "151": $('#ketqua').val(),
                    }
                }
            }
        }
        console.log(data)
        $.ajax({
            type: 'PUT',
            url: url,
            contentType: 'application/json',
            data: JSON.stringify(data), //
        }).done(function () {
            alert('SUCESS')
            getStatus($('#issue-id').val())
        }).fail(function (msg) {
            alert('FAIL')
        }).always(function (msg) {
            console.log('ALWAYS');
        });
    }

    function getFormattedDate(date) {
        let year = date.getFullYear();
        let month = (1 + date.getMonth()).toString().padStart(2, '0');
        let day = date.getDate().toString().padStart(2, '0');
        if (isNaN(year))
            return ""
        else
            return day + '/' + month + '/' + year;
    }

    function changeStatus(status_id) {
        if (status_id == 29) {
            $('#tracker').removeClass('disabled')
            $('#subject').prop('disabled', false)
            $('#titrong').prop('disabled', false)
            $('#description').prop('disabled', false)
            $('#status').removeClass('disabled')
            $('#assign').removeClass('disabled')
            $('#category').removeClass('disabled')
            $('#target_version').removeClass('disabled')
            $('#muctieu').prop('disabled', false)
            $('#lydodung').prop('disabled', false)
            $('#donvido').removeClass('disabled')
            $('#toithieu').prop('disabled', false)
            $('#mongdoi').prop('disabled', false)
            $('#thachthuc').prop('disabled', false)
            $('#ketqua').prop('disabled', false)
            $('#date-toithieu-value').prop('disabled', false)
            $('#date-mongdoi-value').prop('disabled', false)
            $('#date-thachthuc-value').prop('disabled', false)
            $('#date-ketqua-value').prop('disabled', false)
            $('#cbnv_point').addClass('disabled')
            $('#cbnv_point').parent().removeClass('required')
        } else if (status_id == 32) {//thong nhat
            $('#tracker').removeClass('disabled')
            $('#subject').prop('disabled', false)
            $('#titrong').prop('disabled', false)
            $('#description').prop('disabled', false)
            $('#status').removeClass('disabled')
            $('#assign').removeClass('disabled')
            $('#category').removeClass('disabled')
            $('#target_version').removeClass('disabled')
            $('#muctieu').prop('disabled', false)
            $('#lydodung').prop('disabled', false)
            $('#donvido').removeClass('disabled')
            $('#toithieu').prop('disabled', true)
            $('#mongdoi').prop('disabled', true)
            $('#thachthuc').prop('disabled', true)
            $('#ketqua').prop('disabled', false)
            $('#date-toithieu-value').prop('disabled', true)
            $('#date-mongdoi-value').prop('disabled', true)
            $('#date-thachthuc-value').prop('disabled', true)
            $('#date-ketqua-value').prop('disabled', false)
            $('#cbnv_point').addClass('disabled')
            $('#cbnv_point').parent().removeClass('required')
        } else if (status_id == 35) {//huy
            $('#tracker').removeClass('disabled')
            $('#subject').prop('disabled', false)
            $('#titrong').prop('disabled', false)
            $('#description').prop('disabled', false)
            $('#status').removeClass('disabled')
            $('#assign').removeClass('disabled')
            $('#category').removeClass('disabled')
            $('#target_version').removeClass('disabled')
            $('#muctieu').prop('disabled', false)
            $('#lydodung').prop('disabled', false)
            $('#donvido').removeClass('disabled')
            $('#toithieu').prop('disabled', true)
            $('#mongdoi').prop('disabled', true)
            $('#thachthuc').prop('disabled', true)
            $('#ketqua').prop('disabled', false)
            $('#date-toithieu-value').prop('disabled', true)
            $('#date-mongdoi-value').prop('disabled', true)
            $('#date-thachthuc-value').prop('disabled', true)
            $('#date-ketqua-value').prop('disabled', false)
            $('#cbnv_point').addClass('disabled')
            $('#cbnv_point').parent().removeClass('required')
        } else if (status_id == 33) {
            $('#tracker').removeClass('disabled')
            $('#subject').prop('disabled', false)
            $('#titrong').prop('disabled', false)
            $('#description').prop('disabled', false)
            $('#status').removeClass('disabled')
            $('#assign').removeClass('disabled')
            $('#category').removeClass('disabled')
            $('#target_version').removeClass('disabled')
            $('#muctieu').prop('disabled', false)
            $('#lydodung').prop('disabled', false)
            $('#donvido').removeClass('disabled')
            $('#toithieu').prop('disabled', true)
            $('#mongdoi').prop('disabled', true)
            $('#thachthuc').prop('disabled', true)
            $('#ketqua').prop('disabled', false)
            $('#ketqua').parent().addClass('required')
            $('#date-toithieu-value').prop('disabled', true)
            $('#date-mongdoi-value').prop('disabled', true)
            $('#date-thachthuc-value').prop('disabled', true)
            $('#date-ketqua-value').prop('disabled', false)
            $('#cbnv_point').removeClass('disabled')
            $('#cbnv_point').parent().addClass('required')
        }
    }
</script>
<script>
    $('#top-menu').css("height", "50px")
    $('#top-menu').css("z-index", "10")
    $('#top-menu').css("z-index", "10")
    $('.checkbox').css("display", "none");
    $('#top-menu').css("position", "relative")
    $("#tb-dinhluong tr").click(function () {
        $(this).addClass("selected").siblings().removeClass("selected");
    });
    savetable

    function edittable(btn) {
        let id = $(btn).parent().parent().attr("id");
        let cells = $(btn).parent().parent()[0].cells
        $.ajax({
            url: '/my_kpi/status/' + id + '/<%=User.current.id%>.json',
            type: 'GET',
            success: function (response) {
                console.log(response);
                //status
                status_selected = response.status.find(e => e.selected).value
                status_source = response.status.map(x => ({value: x.value, text: x.name}))
                $(cells[0]).find('a').editable({
                    type: 'select',
                    title: 'Select status',
                    placement: 'right',
                    value: status_selected,
                    source: status_source
                }).on('save', function (e, params) {
                    console.log(params)
                });

                // if (status_selected === 29) {
                //muc tieu ket qua
                $(cells[1]).find('a').editable({
                    type: 'textarea',
                    title: 'Mục tiêu kết quả đầu ra',
                    placement: 'right',
                    unsavedclass: null
                })
                //tracker
                tracker_selected = response.tracker.find(e => e.selected).value
                tracker_source = response.tracker.map(x => ({value: x.value, text: x.name}))
                $(cells[2]).find('a').editable({
                    type: 'select',
                    title: 'Select status',
                    placement: 'right',
                    value: tracker_selected,
                    source: tracker_source
                })
                //subject
                $(cells[3]).find('a').editable({
                    type: 'textarea',
                    title: 'Chỉ số KPI',
                    placement: 'right',
                    unsavedclass: null
                })
                //,author
                author_selected = response.author
                author_source = response.assignee.map(x => ({value: x.value, text: x.name}))
                $(cells[4]).find('a').editable({
                    type: 'select',
                    title: 'Select status',
                    placement: 'right',
                    value: author_selected,
                    source: author_source
                })
                if (tracker_selected === 39) {
                    //donvido
                    donvido_selected = response.don_vi_do.find(e => e.selected).value
                    donvido_source = response.don_vi_do.map(x => ({value: x.value, text: x.name}))
                    $(cells[5]).find('a').editable({
                        type: 'select',
                        title: 'Đơn vị đo',
                        placement: 'right',
                        value: donvido_selected,
                        source: donvido_source
                    })
                    $(cells[7]).find('a').editable({
                        type: 'number',
                        step: 'any',
                        title: 'Tối thiểu',
                        placement: 'right',
                        unsavedclass: null
                    })
                    $(cells[8]).find('a').editable({
                        type: 'number',
                        step: 'any',
                        title: 'Mong đợi',
                        placement: 'right',
                        unsavedclass: null
                    })
                    $(cells[9]).find('a').editable({
                        type: 'number',
                        step: 'any',
                        title: 'Thách thức',
                        placement: 'right',
                        unsavedclass: null
                    })
                } else if (tracker_selected === 40) {
                    $(cells[7]).find('a').editable({
                        type: 'date',
                        title: 'Tối thiểu',
                        placement: 'top',
                        unsavedclass: null,
                        format: 'yyyy-mm-dd',
                        viewformat: 'dd/mm/yyyy',
                        datepicker: {
                            weekStart: 1
                        }
                    })
                    $(cells[8]).find('a').editable({
                        type: 'date',
                        title: 'Tối thiểu',
                        placement: 'top',
                        unsavedclass: null,
                        format: 'yyyy-mm-dd',
                        viewformat: 'dd/mm/yyyy',
                        datepicker: {
                            weekStart: 1
                        }
                    })
                    $(cells[9]).find('a').editable({
                        type: 'date',
                        title: 'Tối thiểu',
                        placement: 'top',
                        unsavedclass: null,
                        format: 'yyyy-mm-dd',
                        viewformat: 'dd/mm/yyyy',
                        datepicker: {
                            weekStart: 1
                        }
                    })
                }
                //ty trong
                $(cells[6]).find('a').editable({
                    type: 'number',
                    max: '100',
                    title: 'Chỉ số KPI',
                    placement: 'right',
                    unsavedclass: null
                })

                // }
                $(cells[10]).find('a').editable({
                    type: 'number',
                    step: 'any',
                    'emptytext': 0,
                    title: 'Kết quả thực hiện',
                    placement: 'right',
                    unsavedclass: null
                })

                cbnv_point_selected = typeof response.cbnv_point.find(e => e.selected) !== 'undefined' ? response.cbnv_point.find(e => e.selected).value : null
                cbnv_point_source = response.cbnv_point.map(x => ({value: x.value, text: x.name}))
                $(cells[11]).find('a').editable({
                    type: 'select',
                    title: 'Tự đánh giá điểm',
                    placement: 'left',
                    value: cbnv_point_selected,
                    source: cbnv_point_source,
                    unsavedclass: null

                })
                qltt_point_selected = typeof response.qltt_point.find(e => e.selected) !== 'undefined' ? response.qltt_point.find(e => e.selected).value : null
                qltt_point_source = response.qltt_point.map(x => ({value: x.value, text: x.name}))
                $(cells[12]).find('a').editable({
                    type: 'select',
                    title: 'Tự đánh giá điểm',
                    placement: 'left',
                    value: qltt_point_selected,
                    source: qltt_point_source,
                    unsavedclass: null

                }).on('save', function (e, params) {
                    console.log(params)
                });
            },
            error: function (error) {
                alert('Error: ' + error)
            }
        });

    }

    function savetable(btn) {

        $(btn).parent().parent()[0].cells.forEach(element => {
            content = $(element).find('a')
            content.editable('destroy')
        })
    }

    $('#huyModal').on('show.bs.modal', function (event) {
        let button = $(event.relatedTarget) // Button that triggered the modal
        let id = button.data('whatever') // Extract info from data-* attributes
        let modal = $(this)
        let btnhuy = modal.find('.modal-footer #modal-huy')
        btnhuy.click(function () {
            $('#modal-form').validate();
            if ($('#modal-form').valid()) {
                let url = 'http://' + $(location).attr('host') + '/issues/' + id + '.json?key=<%=User.current.api_key%>';
                let data = {
                    "issue": {
                        "status_id": 35,
                        "custom_field_values": {
                            "47": modal.find('.modal-body textarea').val()
                        }
                    }
                }
                $.ajax({
                    type: 'PUT',
                    url: url,
                    contentType: 'application/json',
                    data: JSON.stringify(data),
                }).done(function () {
                    $('#close-huy').click();
                    $($('#' + id + ' td').first()).find('a').text('4. Hủy (Cancel!!)')
                    $($('#' + id + ' td').last()).empty();
                    $($('#' + id + ' td').last()).append('<button type="button" style="width: 100%" onclick="duthao(' + id + ')" class="btn btn-info">Dự thảo</button>')
                }).fail(function (msg) {
                }).always(function (msg) {
                    console.log('ALWAYS');
                });
            }
        });
    })
    $('#tudanhgiaModal').on('show.bs.modal', function (event) {
        let button = $(event.relatedTarget) // Button that triggered the modal
        let id = button.data('whatever') // Extract info from data-* attributes
        let tracker_id = button.data('tracker') // Extract info from data-* attributes
        let modal = $(this)
        if (tracker_id == 40) {
            $('#ketqua').prop('type', 'date');
        } else if (tracker_id == 39) {
            $('#ketqua').prop('type', 'number');
            $('#ketqua').prop('step', 'any');
        }
        let btn_tudanhgia = modal.find('.modal-footer #btn-tudanhgia')
        btn_tudanhgia.click(function () {
            $('#tudanhgia-form').validate();
            if ($('#tudanhgia-form').valid() && $('#tudanhgia-diem').val() !== "") {
                let url = 'http://' + $(location).attr('host') + '/issues/' + id + '.json?key=<%=User.current.api_key%>';
                let data
                if (tracker_id == 40) {
                    data = {
                        "issue": {
                            "status_id": 33,
                            "custom_field_values": {
                                "149": $('#ketqua').val(),
                                "140": $('#tudanhgia-diem').val()
                            }
                        }
                    }
                } else if (tracker_id == 39) {
                    data = {
                        "issue": {
                            "status_id": 33,
                            "custom_field_values": {
                                "145": $('#ketqua').val(),
                                "140": $('#tudanhgia-diem').val()
                            }
                        }
                    }
                } else {
                    data = {
                        "issue": {
                            "status_id": 33,
                            "custom_field_values": {
                                "151": $('#ketqua').val(),
                                "140": $('#tudanhgia-diem').val()
                            }
                        }
                    }
                }
                console.log(data)
                $.ajax({
                    type: 'PUT',
                    url: url,
                    contentType: 'application/json',
                    data: JSON.stringify(data),
                }).done(function () {
                    $('#close-tudanhgia').click();
                    $($('#' + id + ' td').first()).find('a').text('2. Tự đánh giá (Done!)')
                    $($('#' + id + ' td').eq(11)).find('a').text($("#tudanhgia-diem option:selected").text())
                    let kq = tracker_id == 40 ? getFormattedDate(new Date($('#ketqua').val())) : $('#ketqua').val()
                    $($('#' + id + ' td').eq(10)).find('a').text(kq)
                    $($('#' + id + ' td').last()).empty();
                }).fail(function (msg) {

                }).always(function (msg) {
                    console.log('ALWAYS');
                });

            }
        });

    })

    function duthao(id) {
        let url = 'http://' + $(location).attr('host') + '/issues/' + id + '.json?key=<%=User.current.api_key%>';
        let data = {
            "issue": {
                "status_id": 29,
            }
        }
        $.ajax({
            type: 'PUT',
            url: url,
            contentType: 'application/json',
            data: JSON.stringify(data),
        }).done(function () {
            $($('#' + id + ' td').first()).find('a').text('0. Dự thảo (Draft)')
            $($('#' + id + ' td').last()).empty();
            $($('#' + id + ' td').last()).append('<button style="width: 100%" type="button" class="btn btn-danger" data-toggle="modal" data-target="#huyModal" data-whatever="' + id + '">Hủy KPI </button>')
        }).fail(function (msg) {
            alert('FAIL')
        }).always(function (msg) {
            console.log('ALWAYS');
        });
    }

    function thongnhat(id) {
        let url = 'http://' + $(location).attr('host') + '/issues/' + id + '.json?key=<%=User.current.api_key%>';
        let data = {
            "issue": {
                "status_id": 32,
            }
        }
        $.ajax({
            type: 'PUT',
            url: url,
            contentType: 'application/json',
            data: JSON.stringify(data),
        }).done(function () {
            $($('#' + id + ' td').first()).find('a').text('1. Thống nhất (Signed!)')
            $($('#' + id + ' td').last()).empty();
            $($('#' + id + ' td').last()).append('<button style="width: 100%" type="button" class="btn btn-danger" data-toggle="modal" data-target="#huyModal" data-whatever="' + id + '">Hủy KPI </button>')
        }).fail(function (msg) {
            alert('FAIL')
        }).always(function (msg) {
            console.log('ALWAYS');
        });
    }

</script>